--[[ 
    ðŸ‹ OrcaUI V3: Ultimate Interface Library
    Author: OrcaDev
    Features: Background Particles, Multi-Dropdowns, Smooth Tweens, Clean Design
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")

local Orca = {}

-- // THEME CONFIGURATION \\ --
local Theme = {
    Background = Color3.fromRGB(18, 18, 28),
    Section    = Color3.fromRGB(25, 25, 38),
    Element    = Color3.fromRGB(32, 32, 48),
    Accent     = Color3.fromRGB(0, 190, 255), -- Orca Neon Blue
    Text       = Color3.fromRGB(240, 240, 240),
    SubText    = Color3.fromRGB(140, 140, 160),
    Outline    = Color3.fromRGB(50, 50, 70),
    Font       = Enum.Font.GothamMedium,
    FontBold   = Enum.Font.GothamBold
}

-- // UTILITY FUNCTIONS \\ --
local function GetGuiParent() return (gethui and gethui()) or CoreGui end

local function Create(class, props, children)
    local obj = Instance.new(class)
    for k, v in pairs(props or {}) do obj[k] = v end
    for _, child in pairs(children or {}) do child.Parent = obj end
    return obj
end

local function Tween(obj, props, time, style, dir)
    TweenService:Create(obj, TweenInfo.new(time or 0.25, style or Enum.EasingStyle.Quart, dir or Enum.EasingDirection.Out), props):Play()
end

-- // LIBRARY START \\ --
function Orca:CreateWindow(Config)
    local Title = Config.Title or "Orca Hub"
    local Size = Config.Size or UDim2.fromOffset(580, 400)
    
    local ScreenGui = Create("ScreenGui", {Name = "OrcaV3", Parent = GetGuiParent(), ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
    
    -- Main Container
    local Main = Create("Frame", {
        Name = "Main", Parent = ScreenGui, BackgroundColor3 = Theme.Background,
        Position = UDim2.fromScale(0.5, 0.5), Size = UDim2.fromScale(0, 0), -- Animated Open
        AnchorPoint = Vector2.new(0.5, 0.5), ClipsDescendants = true
    })
    local MainCorner = Create("UICorner", {CornerRadius = UDim.new(0, 12), Parent = Main})
    local MainStroke = Create("UIStroke", {Parent = Main, Color = Theme.Accent, Thickness = 2, Transparency = 0.5})

    -- Drag Logic
    local Dragging, DragInput, DragStart, StartPos
    local DragZone = Create("Frame", {Parent = Main, BackgroundTransparency = 1, Size = UDim2.new(1,0,0,40)})
    DragZone.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true; DragStart = input.Position; StartPos = Main.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then Dragging = false end end)
        end
    end)
    DragZone.InputChanged:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseMovement then DragInput = input end end)
    UserInputService.InputChanged:Connect(function(input)
        if input == DragInput and Dragging then
            local Delta = input.Position - DragStart
            Tween(Main, {Position = UDim2.new(StartPos.X.Scale, StartPos.X.Offset + Delta.X, StartPos.Y.Scale, StartPos.Y.Offset + Delta.Y)}, 0.05)
        end
    end)

    -- // BACKGROUND ANIMATION (Bubbles) \\ --
    local ParticleContainer = Create("Frame", {Parent = Main, BackgroundTransparency = 1, Size = UDim2.fromScale(1,1), ZIndex = 1})
    task.spawn(function()
        while Main.Parent do
            local size = math.random(10, 40)
            local Bubble = Create("Frame", {
                Parent = ParticleContainer, BackgroundColor3 = Theme.Accent, BackgroundTransparency = 0.95,
                Position = UDim2.new(math.random(), 0, 1, 0), Size = UDim2.fromOffset(size, size)
            })
            Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Bubble})
            
            Tween(Bubble, {Position = UDim2.new(Bubble.Position.X.Scale + math.random(-10,10)/100, 0, -0.2, 0)}, math.random(5, 10), Enum.EasingStyle.Quad, Enum.EasingDirection.In)
            task.delay(10, function() Bubble:Destroy() end)
            task.wait(0.8)
        end
    end)

    -- // SIDEBAR \\ --
    local Sidebar = Create("Frame", {
        Parent = Main, BackgroundColor3 = Theme.Section, Size = UDim2.new(0, 160, 1, 0), ZIndex = 2
    })
    Create("UICorner", {CornerRadius = UDim.new(0, 12), Parent = Sidebar})
    Create("Frame", {Parent = Sidebar, BackgroundColor3 = Theme.Section, Size = UDim2.new(0, 10, 1, 0), Position = UDim2.new(1, -10, 0, 0), BorderSizePixel = 0}) -- Square off right side

    -- Title
    Create("TextLabel", {
        Parent = Sidebar, BackgroundTransparency = 1, Text = Title, TextColor3 = Theme.Accent,
        Font = Theme.FontBold, TextSize = 22, Size = UDim2.new(1, -20, 0, 50), Position = UDim2.new(0, 15, 0, 5), TextXAlignment = Enum.TextXAlignment.Left
    })

    -- Tab Button Container
    local TabContainer = Create("ScrollingFrame", {
        Parent = Sidebar, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, -60), Position = UDim2.new(0, 0, 0, 60),
        ScrollBarThickness = 0, CanvasSize = UDim2.new(0,0,0,0)
    })
    local TabLayout = Create("UIListLayout", {Parent = TabContainer, Padding = UDim.new(0, 5), SortOrder = Enum.SortOrder.LayoutOrder})
    Create("UIPadding", {Parent = TabContainer, PaddingLeft = UDim.new(0, 10)})

    -- // PAGE CONTAINER \\ --
    local PageContainer = Create("Frame", {
        Parent = Main, BackgroundTransparency = 1, Size = UDim2.new(1, -175, 1, -20), Position = UDim2.new(0, 170, 0, 10), ZIndex = 2
    })
    local PageFolder = Create("Folder", {Parent = PageContainer})

    -- Open Animation
    Tween(Main, {Size = Size}, 0.6, Enum.EasingStyle.Elastic)

    -- // NOTIFICATION SYSTEM \\ --
    local NotifContainer = Create("Frame", {
        Parent = ScreenGui, BackgroundTransparency = 1, Size = UDim2.new(0, 300, 1, 0), Position = UDim2.new(1, -320, 0, 20)
    })
    local NotifLayout = Create("UIListLayout", {Parent = NotifContainer, Padding = UDim.new(0, 10), VerticalAlignment = Enum.VerticalAlignment.Bottom, SortOrder = Enum.SortOrder.LayoutOrder})

    function Orca:Notify(cfg)
        local NTitle = cfg.Title or "Notification"
        local NText = cfg.Content or ""
        local NDur = cfg.Duration or 3

        local Card = Create("Frame", {
            Parent = NotifContainer, BackgroundColor3 = Theme.Background, Size = UDim2.new(1, 0, 0, 0),
            BorderColor3 = Theme.Accent, BorderMode = Enum.BorderMode.Inset, ClipsDescendants = true
        })
        Create("UICorner", {Parent = Card, CornerRadius = UDim.new(0, 8)})
        Create("UIStroke", {Parent = Card, Color = Theme.Accent, Thickness = 1.5})
        
        local NLabel = Create("TextLabel", {
            Parent = Card, BackgroundTransparency = 1, Text = NTitle, TextColor3 = Theme.Accent,
            Font = Theme.FontBold, TextSize = 14, Size = UDim2.new(1, -10, 0, 20), Position = UDim2.new(0, 10, 0, 5), TextXAlignment = Enum.TextXAlignment.Left
        })
        Create("TextLabel", {
            Parent = Card, BackgroundTransparency = 1, Text = NText, TextColor3 = Theme.Text,
            Font = Theme.Font, TextSize = 13, Size = UDim2.new(1, -10, 0, 20), Position = UDim2.new(0, 10, 0, 25), TextXAlignment = Enum.TextXAlignment.Left, TextWrapped = true
        })

        Tween(Card, {Size = UDim2.new(1, 0, 0, 60)}, 0.3)
        task.delay(NDur, function()
            Tween(Card, {Size = UDim2.new(1, 0, 0, 0), BackgroundTransparency = 1}, 0.3)
            task.wait(0.3)
            Card:Destroy()
        end)
    end

    -- // WINDOW FUNCTIONS \\ --
    local Window = {CurrentTab = nil}

    function Window:CreateTab(Name, Icon)
        local Tab = {}
        
        -- Tab Button
        local Btn = Create("TextButton", {
            Parent = TabContainer, BackgroundColor3 = Theme.Background, BackgroundTransparency = 1,
            Size = UDim2.new(1, -15, 0, 32), Text = "", AutoButtonColor = false
        })
        local BtnCorner = Create("UICorner", {Parent = Btn, CornerRadius = UDim.new(0, 6)})
        local BtnText = Create("TextLabel", {
            Parent = Btn, BackgroundTransparency = 1, Text = Name, TextColor3 = Theme.SubText,
            Font = Theme.Font, TextSize = 14, Size = UDim2.new(1, -30, 1, 0), Position = UDim2.new(0, 10, 0, 0), TextXAlignment = Enum.TextXAlignment.Left
        })
        
        -- Indicator (The blue line on active tabs)
        local Indicator = Create("Frame", {
            Parent = Btn, BackgroundColor3 = Theme.Accent, Size = UDim2.new(0, 0, 0.6, 0), Position = UDim2.new(0, 0, 0.2, 0)
        })
        Create("UICorner", {Parent = Indicator, CornerRadius = UDim.new(1,0)})

        -- Page
        local Page = Create("ScrollingFrame", {
            Parent = PageFolder, BackgroundTransparency = 1, Size = UDim2.fromScale(1, 1), Visible = false,
            ScrollBarThickness = 2, ScrollBarImageColor3 = Theme.Accent, CanvasSize = UDim2.new(0,0,0,0)
        })
        local PageLayout = Create("UIListLayout", {Parent = Page, Padding = UDim.new(0, 8), SortOrder = Enum.SortOrder.LayoutOrder})
        Create("UIPadding", {Parent = Page, PaddingRight = UDim.new(0, 6), PaddingBottom = UDim.new(0, 10)})

        PageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Page.CanvasSize = UDim2.new(0, 0, 0, PageLayout.AbsoluteContentSize.Y + 10)
        end)

        -- Activation
        local function Activate()
            if Window.CurrentTab then
                Tween(Window.CurrentTab.BtnText, {TextColor3 = Theme.SubText})
                Tween(Window.CurrentTab.Indicator, {Size = UDim2.new(0, 0, 0.6, 0)})
                Window.CurrentTab.Page.Visible = false
            end
            
            Window.CurrentTab = {BtnText = BtnText, Indicator = Indicator, Page = Page}
            Tween(BtnText, {TextColor3 = Theme.Text})
            Tween(Indicator, {Size = UDim2.new(0, 4, 0.6, 0)})
            Page.Visible = true
        end

        Btn.MouseButton1Click:Connect(Activate)
        if Window.CurrentTab == nil then Activate() end -- First tab auto-select

        -- // ELEMENTS \\ --
        
        function Tab:CreateSection(Text)
            local Section = Create("Frame", {Parent = Page, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 30)})
            Create("TextLabel", {
                Parent = Section, Text = Text, Font = Theme.FontBold, TextSize = 13, TextColor3 = Theme.Accent,
                BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, 0), TextXAlignment = Enum.TextXAlignment.Left
            })
        end

        function Tab:CreateButton(cfg)
            local Callback = cfg.Callback or function() end
            local BtnFrame = Create("TextButton", {
                Parent = Page, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, 38),
                Text = "", AutoButtonColor = false
            })
            Create("UICorner", {Parent = BtnFrame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = BtnFrame, Color = Theme.Outline, Thickness = 1})
            
            Create("TextLabel", {
                Parent = BtnFrame, Text = cfg.Name, Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Text,
                BackgroundTransparency = 1, Size = UDim2.new(1, -10, 1, 0), Position = UDim2.new(0, 10, 0, 0), TextXAlignment = Enum.TextXAlignment.Left
            })
            local Icon = Create("ImageLabel", {
                Parent = BtnFrame, Image = "rbxassetid://10709791437", BackgroundTransparency = 1,
                Size = UDim2.new(0, 20, 0, 20), Position = UDim2.new(1, -30, 0.5, -10), ImageColor3 = Theme.SubText
            })

            BtnFrame.MouseEnter:Connect(function() Tween(BtnFrame, {BackgroundColor3 = Color3.fromRGB(45, 45, 60)}) end)
            BtnFrame.MouseLeave:Connect(function() Tween(BtnFrame, {BackgroundColor3 = Theme.Element}) end)
            BtnFrame.MouseButton1Click:Connect(function()
                Tween(BtnFrame, {BackgroundColor3 = Theme.Accent}, 0.1)
                task.wait(0.1)
                Tween(BtnFrame, {BackgroundColor3 = Color3.fromRGB(45, 45, 60)}, 0.1)
                Callback()
            end)
        end

        function Tab:CreateToggle(cfg)
            local Callback = cfg.Callback or function() end
            local State = cfg.CurrentValue or false
            
            local ToggleFrame = Create("TextButton", {
                Parent = Page, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, 38),
                Text = "", AutoButtonColor = false
            })
            Create("UICorner", {Parent = ToggleFrame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = ToggleFrame, Color = Theme.Outline, Thickness = 1})
            
            Create("TextLabel", {
                Parent = ToggleFrame, Text = cfg.Name, Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Text,
                BackgroundTransparency = 1, Size = UDim2.new(1, -60, 1, 0), Position = UDim2.new(0, 10, 0, 0), TextXAlignment = Enum.TextXAlignment.Left
            })

            local SwitchInfo = Create("Frame", {
                Parent = ToggleFrame, BackgroundColor3 = Theme.Background, Size = UDim2.new(0, 40, 0, 20),
                Position = UDim2.new(1, -50, 0.5, -10)
            })
            Create("UICorner", {Parent = SwitchInfo, CornerRadius = UDim.new(1, 0)})
            
            local Circle = Create("Frame", {
                Parent = SwitchInfo, BackgroundColor3 = Theme.SubText, Size = UDim2.new(0, 16, 0, 16),
                Position = UDim2.new(0, 2, 0.5, -8)
            })
            Create("UICorner", {Parent = Circle, CornerRadius = UDim.new(1, 0)})

            local function Update()
                if State then
                    Tween(SwitchInfo, {BackgroundColor3 = Theme.Accent})
                    Tween(Circle, {Position = UDim2.new(1, -18, 0.5, -8), BackgroundColor3 = Color3.new(1,1,1)})
                else
                    Tween(SwitchInfo, {BackgroundColor3 = Theme.Background})
                    Tween(Circle, {Position = UDim2.new(0, 2, 0.5, -8), BackgroundColor3 = Theme.SubText})
                end
                Callback(State)
            end
            if State then Update() end

            ToggleFrame.MouseButton1Click:Connect(function()
                State = not State
                Update()
            end)
        end

        function Tab:CreateSlider(cfg)
            local Callback = cfg.Callback or function() end
            local Min, Max = cfg.Range[1], cfg.Range[2]
            local Value = cfg.CurrentValue or Min

            local SliderFrame = Create("Frame", {
                Parent = Page, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, 50)
            })
            Create("UICorner", {Parent = SliderFrame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = SliderFrame, Color = Theme.Outline, Thickness = 1})

            Create("TextLabel", {
                Parent = SliderFrame, Text = cfg.Name, Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Text,
                BackgroundTransparency = 1, Position = UDim2.new(0, 10, 0, 5), Size = UDim2.new(1, -20, 0, 20), TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local ValueLabel = Create("TextLabel", {
                Parent = SliderFrame, Text = tostring(Value), Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Accent,
                BackgroundTransparency = 1, Position = UDim2.new(1, -60, 0, 5), Size = UDim2.new(0, 50, 0, 20), TextXAlignment = Enum.TextXAlignment.Right
            })

            local Bar = Create("Frame", {
                Parent = SliderFrame, BackgroundColor3 = Theme.Background, Size = UDim2.new(1, -20, 0, 6),
                Position = UDim2.new(0, 10, 0, 32)
            })
            Create("UICorner", {Parent = Bar, CornerRadius = UDim.new(1, 0)})

            local Fill = Create("Frame", {
                Parent = Bar, BackgroundColor3 = Theme.Accent, Size = UDim2.new((Value-Min)/(Max-Min), 0, 1, 0)
            })
            Create("UICorner", {Parent = Fill, CornerRadius = UDim.new(1, 0)})

            local Dragging = false
            local function UpdateInput(input)
                local pos = math.clamp((input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
                Value = math.floor(Min + ((Max - Min) * pos))
                Tween(Fill, {Size = UDim2.fromScale(pos, 1)}, 0.05)
                ValueLabel.Text = tostring(Value)
                Callback(Value)
            end

            SliderFrame.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = true UpdateInput(i) end end)
            UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end end)
            UserInputService.InputChanged:Connect(function(i) if Dragging and i.UserInputType == Enum.UserInputType.MouseMovement then UpdateInput(i) end end)
        end

        function Tab:CreateMultiDropdown(cfg)
            local Name = cfg.Name
            local Options = cfg.Options or {}
            local Callback = cfg.Callback or function() end
            local Selected = {} -- Table to store selected items

            local Height = 38
            local ExpandedHeight = math.min(#Options * 30 + 40, 180)
            local Expanded = false

            local Frame = Create("Frame", {
                Parent = Page, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, Height),
                ClipsDescendants = true
            })
            Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = Frame, Color = Theme.Outline, Thickness = 1})

            local Header = Create("TextButton", {
                Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 0, 38), Text = "", AutoButtonColor = false
            })
            
            local TitleLabel = Create("TextLabel", {
                Parent = Header, Text = Name .. ": None", Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Text,
                BackgroundTransparency = 1, Size = UDim2.new(1, -40, 1, 0), Position = UDim2.new(0, 10, 0, 0), TextXAlignment = Enum.TextXAlignment.Left
            })
            
            local Icon = Create("ImageLabel", {
                Parent = Header, Image = "rbxassetid://6031091004", BackgroundTransparency = 1,
                Size = UDim2.new(0, 20, 0, 20), Position = UDim2.new(1, -30, 0.5, -10), ImageColor3 = Theme.SubText
            })

            local List = Create("ScrollingFrame", {
                Parent = Frame, BackgroundTransparency = 1, Size = UDim2.new(1, 0, 1, -40), Position = UDim2.new(0, 0, 0, 40),
                ScrollBarThickness = 2, CanvasSize = UDim2.new(0,0,0,0)
            })
            local ListLayout = Create("UIListLayout", {Parent = List, SortOrder = Enum.SortOrder.LayoutOrder})

            -- Logic
            local function UpdateText()
                local text = ""
                local count = 0
                for k, v in pairs(Selected) do
                    if v then 
                        if count > 0 then text = text .. ", " end
                        text = text .. k
                        count = count + 1
                    end
                end
                if count == 0 then text = "None" end
                TitleLabel.Text = Name .. ": " .. text
                Callback(Selected) -- Returns table {Option1=true, Option2=false}
            end

            for _, opt in pairs(Options) do
                local OptBtn = Create("TextButton", {
                    Parent = List, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, 30),
                    Text = "  " .. opt, Font = Theme.Font, TextColor3 = Theme.SubText, TextSize = 13,
                    TextXAlignment = Enum.TextXAlignment.Left, AutoButtonColor = false
                })
                
                OptBtn.MouseButton1Click:Connect(function()
                    if Selected[opt] then
                        Selected[opt] = nil
                        Tween(OptBtn, {TextColor3 = Theme.SubText, BackgroundColor3 = Theme.Element})
                    else
                        Selected[opt] = true
                        Tween(OptBtn, {TextColor3 = Theme.Accent, BackgroundColor3 = Color3.fromRGB(40,40,55)})
                    end
                    UpdateText()
                end)
            end
            List.CanvasSize = UDim2.new(0,0,0, ListLayout.AbsoluteContentSize.Y)

            Header.MouseButton1Click:Connect(function()
                Expanded = not Expanded
                Tween(Frame, {Size = UDim2.new(1, 0, 0, Expanded and ExpandedHeight or Height)}, 0.3)
                Tween(Icon, {Rotation = Expanded and 180 or 0}, 0.3)
            end)
        end

        function Tab:CreateInput(cfg)
            local Callback = cfg.Callback or function() end
            local InputFrame = Create("Frame", {
                Parent = Page, BackgroundColor3 = Theme.Element, Size = UDim2.new(1, 0, 0, 40)
            })
            Create("UICorner", {Parent = InputFrame, CornerRadius = UDim.new(0, 6)})
            Create("UIStroke", {Parent = InputFrame, Color = Theme.Outline, Thickness = 1})

            Create("TextLabel", {
                Parent = InputFrame, Text = cfg.Name, Font = Theme.Font, TextSize = 14, TextColor3 = Theme.Text,
                BackgroundTransparency = 1, Size = UDim2.new(0, 100, 1, 0), Position = UDim2.new(0, 10, 0, 0), TextXAlignment = Enum.TextXAlignment.Left
            })

            local Box = Create("TextBox", {
                Parent = InputFrame, BackgroundColor3 = Theme.Background, TextColor3 = Theme.Accent,
                PlaceholderText = cfg.Placeholder or "Type...", Text = "", Font = Theme.Font, TextSize = 13,
                Size = UDim2.new(0, 140, 0, 24), Position = UDim2.new(1, -150, 0.5, -12)
            })
            Create("UICorner", {Parent = Box, CornerRadius = UDim.new(0, 4)})

            Box.FocusLost:Connect(function(enter)
                if enter then Callback(Box.Text) end
            end)
        end

        return Tab
    end

    return Window
end

return Orca
